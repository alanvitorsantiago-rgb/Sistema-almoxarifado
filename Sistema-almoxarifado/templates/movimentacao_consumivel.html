{% extends "base.html" %}

{% block title %}Movimentação de Consumíveis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-8">
            <h2 class="text-white"><i class="fas fa-exchange-alt me-2"></i> Movimentação de Consumíveis</h2>
            <p class="text-muted">Registre entradas e saídas de itens consumíveis do estoque.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('consumivel') }}" class="btn btn-secondary"><i class="fas fa-list me-2"></i> Ver Estoque de Consumíveis</a>
        </div>
    </div>

    <div class="card bg-dark-2 border-secondary shadow-sm">
        <div class="card-body">
            <form method="POST" action="{{ url_for('movimentacao_consumivel') }}" id="form-movimentacao">
                <!-- Campo oculto para armazenar o ID do consumível encontrado -->
                <input type="hidden" id="consumivel_id" name="consumivel_id">
                
                <!-- CAMPO DE BUSCA POR CÓDIGO -->
                <div class="mb-3">
                    <label for="codigo_produto_input" class="form-label">1. Código do Consumível</label>
                    <input type="text" class="form-control form-control-lg" id="codigo_produto_input" placeholder="Digite o código e pressione Enter" autofocus>
                    <div class="form-text">Busque pelo código do produto para carregar suas informações.</div>
                </div>

                <!-- INFORMAÇÕES EM TEMPO REAL DO ITEM -->
                <div id="info-consumivel" class="row mb-3 p-3 bg-dark-3 rounded border border-secondary" style="display: none;">
                    <div class="col-md-4">
                        <strong>Descrição:</strong> <span id="info-descricao" class="text-info"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Categoria:</strong> <span id="info-categoria" class="text-info"></span>
                    </div>
                    <div class="col-md-2">
                        <strong>Unidade:</strong> <span id="info-unidade" class="text-info"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Qtd. em Estoque:</strong> <span id="info-qtd" class="text-info fw-bold"></span>
                    </div>
                </div>

                <!-- DADOS DA MOVIMENTAÇÃO -->
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="tipo" class="form-label">2. Tipo de Movimentação</label>
                        <select class="form-select" id="tipo" name="tipo" required>
                            <option value="ENTRADA">Entrada (Recebimento)</option>
                            <option value="SAIDA">Saída (Uso/Entrega)</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="quantidade" class="form-label">3. Quantidade</label>
                        <input type="number" step="any" class="form-control" id="quantidade" name="quantidade" required placeholder="Ex: 10">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="etapa_destino" class="form-label">4. Etapa de Destino</label>
                        <select class="form-select" id="etapa_destino" name="setor_destino" required style="background-color: #1a1a2e; border: 1px solid #495057; color: #ffffff;">
                            <option value="" style="color: #ffffff; background-color: #1a1a2e;">Selecione a etapa...</option>
                            <option value="Etapa 1 - Almoxarifado" style="color: #ffffff; background-color: #1a1a2e;">Etapa 1 - Almoxarifado</option>
                            <option value="Etapa 2 - Usinagem CNC" style="color: #ffffff; background-color: #1a1a2e;">Etapa 2 - Usinagem CNC</option>
                            <option value="Etapa 3 - Preparação e Acabamento" style="color: #ffffff; background-color: #1a1a2e;">Etapa 3 - Preparação e Acabamento</option>
                            <option value="Etapa 4 - Preenchimento de Núcleos" style="color: #ffffff; background-color: #1a1a2e;">Etapa 4 - Preenchimento de Núcleos</option>
                            <option value="Etapa 5 - Fabricação de Pisos" style="color: #ffffff; background-color: #1a1a2e;">Etapa 5 - Fabricação de Pisos</option>
                            <option value="Etapa 6 - Ajuste e Montagem" style="color: #ffffff; background-color: #1a1a2e;">Etapa 6 - Ajuste e Montagem</option>
                            <option value="Etapa 7 - Proteção de Superfícies" style="color: #ffffff; background-color: #1a1a2e;">Etapa 7 - Proteção de Superfícies</option>
                            <option value="Etapa 8 - Qualidade" style="color: #ffffff; background-color: #1a1a2e;">Etapa 8 - Qualidade</option>
                            <option value="Etapa 9 - Recebimento - Embalagem - Expedição" style="color: #ffffff; background-color: #1a1a2e;">Etapa 9 - Recebimento - Embalagem - Expedição</option>
                            <option value="Etapa 10 - Manutenção" style="color: #ffffff; background-color: #1a1a2e;">Etapa 10 - Manutenção</option>
                            <option value="Etapa 11 - Tratamento Térmico" style="color: #ffffff; background-color: #1a1a2e;">Etapa 11 - Tratamento Térmico</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="observacao" class="form-label">5. Observação (Opcional)</label>
                    <textarea class="form-control" id="observacao" name="observacao" rows="2" placeholder="Ex: Recebido do fornecedor X, entrega para setor de pintura..."></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-check-circle me-2"></i> Registrar Movimentação</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    const codigoInput = $('#codigo_produto_input');
    const consumivelIdInput = $('#consumivel_id');
    const infoContainer = $('#info-consumivel');
    const submitButton = $('#form-movimentacao button[type="submit"]');

    function limparBusca() {
        consumivelIdInput.val('');
        infoContainer.slideUp();
        codigoInput.val('').prop('disabled', false).focus();
        submitButton.prop('disabled', true);
    }

    // Adiciona um botão de limpar dentro do campo de informações
    infoContainer.prepend('<button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Limpar" id="limpar-busca"></button>');
    $('#limpar-busca').on('click', limparBusca);

    // Evento para buscar ao pressionar Enter
    codigoInput.on('keypress', function(e) {
        if (e.which === 13) { // 13 é o código da tecla Enter
            e.preventDefault();
            const codigo = $(this).val().trim();
            if (!codigo) return;

            fetch(`/api/consumivel/by-code/${codigo}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Consumível não encontrado');
                    }
                    return response.json();
                })
                .then(data => {
                    // Preenche as informações
                    $('#info-descricao').text(data.descricao);
                    $('#info-categoria').text(data.categoria || 'N/A');
                    $('#info-unidade').text(data.unidade_medida || 'N/A');
                    $('#info-qtd').text(data.quantidade_atual);
                    
                    // Armazena o ID e atualiza a UI
                    consumivelIdInput.val(data.id);
                    infoContainer.slideDown();
                    codigoInput.prop('disabled', true);
                    submitButton.prop('disabled', false);
                    $('#quantidade').focus(); // Move o foco para o campo de quantidade
                })
                .catch(error => {
                    alert(error.message);
                    limparBusca();
                });
        }
    });

    // Interceptar o envio do formulário para recarregar a aba de relatório
    $('#form-movimentacao').on('submit', function(e) {
        // Deixar o formulário ser enviado normalmente
        // Mas após sucesso, recarregar os dados da aba de relatório
        setTimeout(function() {
            // Recarregar os dados do relatório após a movimentação ser salva
            fetch('/api/relatorio/movimentacoes-consumivel')
                .then(response => response.json())
                .then(data => {
                    console.log('Relatório atualizado com ' + data.length + ' movimentações');
                })
                .catch(error => console.error('Erro ao recarregar:', error));
        }, 1000); // Aguarda 1 segundo para garantir que a movimentação foi salva
    });

    // Inicia com o botão de registrar desabilitado
    submitButton.prop('disabled', true);
});
</script>
{% endblock %}