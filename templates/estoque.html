{% extends 'base.html' %}

{% block title %}Estoque Detalhado por Lote/NF - SERCO ENGENHARIA Almoxarifado{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-database me-2"></i>Estoque Detalhado
        </h2>
        <p class="text-secondary mb-0" style="font-size: 0.9rem; letter-spacing: 0.05em;">
            <i class="fas fa-layer-group me-1"></i>Controle por Lote/NF
            {% if search_query %}
            <span class="ms-3">
                <i class="fas fa-search me-1"></i>Busca: <span class="text-neon-cyan">"{{ search_query }}"</span>
            </span>
            {% endif %}
        </p>
    </div>
    <div class="btn-group" role="group">
        <a href="{{ url_for('cadastro') }}" class="btn btn-futuristic btn-cyan">
            <i class="fas fa-plus me-2"></i>Novo Item
        </a>
        <a href="{{ url_for('movimentacao') }}" class="btn btn-futuristic btn-purple">
            <i class="fas fa-exchange-alt me-2"></i>Movimentar
        </a>
    </div>
</div>

<!-- Search Bar HUD -->
<div class="card-hud mb-4">
    <div class="card-body py-3">
        <form action="{{ url_for('estoque') }}" method="get" class="row g-3 align-items-center">
            <div class="col-md-8">
                <div class="input-group search-bar-hud">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control input-futuristic" name="q"
                        placeholder="Pesquisar por Código, Descrição, Lote, NF..." value="{{ search_query or '' }}"
                        autocomplete="off">
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-futuristic btn-cyan flex-fill">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                    <a href="{{ url_for('estoque') }}" class="btn btn-futuristic btn-outline-futuristic flex-fill">
                        <i class="fas fa-eraser me-1"></i>Limpar
                    </a>
                    <a href="{{ url_for('exportar_excel') }}" class="btn btn-futuristic btn-green">
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Stock Table -->
<div class="card-hud">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-futuristic mb-0">
                <thead>
                    <tr>
                        <th scope="col" class="ps-4" style="width: 10%;">
                            <i class="fas fa-barcode me-1"></i>CÓDIGO
                        </th>
                        <th scope="col" style="width: 10%;">
                            <i class="fas fa-map-marker-alt me-1"></i>ENDEREÇO
                        </th>
                        <th scope="col" style="width: 24%;">
                            <i class="fas fa-tag me-1"></i>DESCRIÇÃO
                        </th>
                        <th scope="col" style="width: 10%;">
                            <i class="fas fa-box me-1"></i>LOTE
                        </th>
                        <th scope="col" style="width: 9%;">
                            <i class="fas fa-file-invoice me-1"></i>ITEM NF
                        </th>
                        <th scope="col" style="width: 9%;">
                            <i class="fas fa-receipt me-1"></i>NF
                        </th>
                        <th scope="col" class="text-center" style="width: 10%;">
                            <i class="fas fa-calendar-alt me-1"></i>VALIDADE
                        </th>
                        <th scope="col" class="text-center" style="width: 8%;">
                            <i class="fas fa-cubes me-1"></i>QTD
                        </th>
                        <th scope="col" class="text-end pe-4" style="width: 10%;">
                            <i class="fas fa-cog me-1"></i>AÇÕES
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote_detalhe in lotes_detalhados %}
                    {# --- Lógica de Status de Validade --- #}
                    {% set status_info = calculate_status(lote_detalhe.validade) %}
                    {% set status_text = status_info[0] %}
                    {% set status_class = status_info[1] %}

                    <tr>
                        <!-- Código -->
                        <td class="ps-4">
                            <span class="badge-codigo">
                                {{ lote_detalhe.item_estoque.codigo }}
                            </span>
                        </td>

                        <!-- Endereço -->
                        <td>
                            {% if lote_detalhe.item_estoque.endereco %}
                            <span class="text-mono"
                                style="color: var(--neon-purple); font-size: 0.85rem; font-weight: 600;">
                                <i class="fas fa-map-marker-alt me-1" style="font-size: 0.75rem;"></i>{{
                                lote_detalhe.item_estoque.endereco }}
                            </span>
                            {% else %}
                            <span class="text-muted fst-italic" style="font-size: 0.8rem;">-</span>
                            {% endif %}
                        </td>

                        <!-- Descrição -->
                        <td>
                            {% if lote_detalhe.item_estoque.descricao %}
                            <div class="text-truncate"
                                style="max-width: 250px; color: var(--text-primary); font-weight: 500;"
                                title="{{ lote_detalhe.item_estoque.descricao }}">
                                {{ lote_detalhe.item_estoque.descricao }}
                            </div>
                            {% else %}
                            <span class="text-muted fst-italic">Sem descrição</span>
                            {% endif %}
                        </td>

                        <!-- Lote -->
                        <td>
                            <span class="text-mono" style="color: var(--text-secondary); font-size: 0.9rem;">
                                {{ lote_detalhe.lote }}
                            </span>
                        </td>

                        <!-- Item NF -->
                        <td>
                            <span class="text-mono" style="color: var(--text-secondary); font-size: 0.9rem;">
                                {{ lote_detalhe.item_nf }}
                            </span>
                        </td>

                        <!-- NF -->
                        <td>
                            <span class="text-mono" style="color: var(--text-secondary); font-size: 0.9rem;">
                                {{ lote_detalhe.nf or '-' }}
                            </span>
                        </td>

                        <!-- Validade (DESTAQUE DINÂMICO) -->
                        <td class="text-center">
                            {% if lote_detalhe.validade %}
                            {# Calculate days until expiration using today_date passed from backend #}
                            {% set days_to_expire = (lote_detalhe.validade - today_date).days %}

                            {% if days_to_expire < 0 %} <span class="badge-validade"
                                style="color: var(--neon-red); border-color: var(--neon-red); background: rgba(255, 0, 110, 0.15); box-shadow: 0 0 5px rgba(255,0,110,0.3);">
                                {{ lote_detalhe.validade.strftime('%d/%m/%Y') }}
                                </span>
                                <div
                                    style="color: var(--neon-red); font-size: 0.65rem; font-weight: bold; margin-top: 2px;">
                                    VENCIDO</div>
                                {% elif days_to_expire == 0 %}
                                <span class="badge-validade"
                                    style="color: var(--neon-red); border-color: var(--neon-red); background: rgba(255, 0, 110, 0.15); animation: pulse-red 2s infinite;">
                                    {{ lote_detalhe.validade.strftime('%d/%m/%Y') }}
                                </span>
                                <div
                                    style="color: var(--neon-red); font-size: 0.65rem; font-weight: bold; margin-top: 2px;">
                                    VENCE HOJE</div>
                                {% elif days_to_expire <= 30 %} <span class="badge-validade"
                                    style="color: var(--neon-yellow); border-color: var(--neon-yellow); background: rgba(255, 214, 10, 0.15);">
                                    {{ lote_detalhe.validade.strftime('%d/%m/%Y') }}
                                    </span>
                                    {% else %}
                                    <span class="badge-validade"
                                        style="color: var(--neon-green); border-color: var(--neon-green); background: rgba(0, 255, 157, 0.1);">
                                        {{ lote_detalhe.validade.strftime('%d/%m/%Y') }}
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                        </td>

                        <!-- Quantidade -->
                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center">
                                <span class="badge-qtd">
                                    {{ lote_detalhe.quantidade|int if lote_detalhe.quantidade.is_integer() else
                                    lote_detalhe.quantidade|round(2) }}
                                </span>
                                <span class="text-muted" style="font-size: 0.7rem; letter-spacing: 0.05em;">
                                    {{ lote_detalhe.item_estoque.un or '' }}
                                </span>
                            </div>
                        </td>

                        <!-- Ações (Botões Coloridos) -->
                        <td class="text-end pe-4">
                            <div class="action-btn-group justify-content-end">
                                <!-- Histórico - Cyan -->
                                <a href="{{ url_for('historico', item_id=lote_detalhe.item_estoque.id) }}"
                                    class="action-btn action-btn-history" data-bs-toggle="tooltip"
                                    title="Histórico de Movimentações">
                                    <i class="fas fa-history"></i>
                                </a>

                                <!-- Detalhes - Blue -->
                                <a href="{{ url_for('detalhes_lotes', item_id=lote_detalhe.item_estoque_id) }}"
                                    class="action-btn action-btn-details" data-bs-toggle="tooltip"
                                    title="Detalhes do Lote">
                                    <i class="fas fa-box"></i>
                                </a>

                                {% if current_user.role == 'admin' %}
                                <!-- Editar - Yellow -->
                                <a href="{{ url_for('editar_lote', detalhe_id=lote_detalhe.id) }}"
                                    class="action-btn action-btn-edit" data-bs-toggle="tooltip" title="Editar Lote">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>

                                <!-- Excluir - Red -->
                                <a href="{{ url_for('excluir_lote', detalhe_id=lote_detalhe.id) }}"
                                    class="action-btn action-btn-delete" data-bs-toggle="tooltip" title="Excluir Lote"
                                    onclick="return confirm('⚠️ Tem certeza que deseja excluir este lote?\n\nCódigo: {{ lote_detalhe.item_estoque.codigo }}\nLote: {{ lote_detalhe.lote }}\nQuantidade: {{ lote_detalhe.quantidade }}');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <!-- Empty State -->
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div style="opacity: 0.6;">
                                <i class="fas fa-box-open fa-4x mb-3"
                                    style="color: var(--neon-cyan); opacity: 0.3;"></i>
                                <h5 class="text-secondary">Nenhum item encontrado</h5>
                                <p class="text-muted small mb-3">
                                    {% if search_query %}
                                    Nenhum resultado para a busca "{{ search_query }}"
                                    {% else %}
                                    O estoque está vazio. Cadastre um novo item para começar.
                                    {% endif %}
                                </p>
                                <a href="{{ url_for('cadastro') }}" class="btn btn-futuristic btn-cyan btn-sm">
                                    <i class="fas fa-plus me-1"></i>Cadastrar Novo Item
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Navegação de páginas de estoque">
        <ul class="pagination">
            <!-- Previous Page -->
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('estoque', page=pagination.prev_num, q=search_query) if pagination.has_prev else '#' }}"
                    aria-label="Anterior">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>

            <!-- Page Numbers -->
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('estoque', page=page_num, q=search_query) }}">
                    {{ page_num }}
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">…</span>
            </li>
            {% endif %}
            {% endfor %}

            <!-- Next Page -->
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('estoque', page=pagination.next_num, q=search_query) if pagination.has_next else '#' }}"
                    aria-label="Próxima">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>

<!-- Pagination Info -->
<div class="text-center mt-2">
    <small class="text-muted">
        Exibindo {{ pagination.items|length }} de {{ pagination.total }} registros
        (Página {{ pagination.page }} de {{ pagination.pages }})
    </small>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Auto-focus search input on page load
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.querySelector('input[name="q"]');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
    });

    // Add keyboard shortcut for search (Ctrl+K or Cmd+K)
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.querySelector('input[name="q"]').focus();
        }
    });

    // Highlight search term in results
    {% if search_query %}
    document.addEventListener('DOMContentLoaded', function () {
        const searchTerm = "{{ search_query }}";
        if (searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            document.querySelectorAll('tbody td').forEach(cell => {
                if (cell.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                    cell.innerHTML = cell.innerHTML.replace(regex, '<mark style="background: rgba(255, 214, 10, 0.3); color: var(--neon-yellow); padding: 2px 4px; border-radius: 3px;">$1</mark>');
                }
            });
        }
    });
    {% endif %}
</script>
{% endblock %}