{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>{{ title }}</h3>
    </div>
    <div class="card-body">
        <!-- Gráfico de Pizza -->
        {% if pie_chart_data.counts | sum > 0 %}
        <div class="row mb-4 justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="p-3 border rounded">
                    <h5 class="text-center mb-3">Proporção de Movimentações (por transação)</h5>
                    <div style="max-height: 300px;">
                        <canvas id="movimentacoesPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    <div class="card-body">
        <!-- Formulário de Filtro -->
        <form method="get" action="{{ url_for('relatorio_movimentacoes') }}" class="mb-4 p-3 border rounded">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data de Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="q" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="q" name="q" placeholder="Código, descrição, lote, usuário..." value="{{ search_query or '' }}">
                </div>
                <div class="col-md-2 d-flex">
                    <button type="submit" class="btn btn-primary w-100 me-2"><i class="fas fa-filter"></i> Filtrar</button>
                    <a href="{{ url_for('relatorio_movimentacoes') }}" class="btn btn-secondary" title="Limpar Filtros"><i class="fas fa-eraser"></i></a>
                </div>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Data/Hora</th>
                        <th>Item (Código/Descrição)</th>
                        <th>Tipo</th>
                        <th class="text-center">Quantidade</th>
                        <th>Lote / Item NF</th>
                        <th>Etapa</th>
                        <th>Usuário</th>
                        <th>Observação</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in movimentacoes %}
                    <tr style="{% if 'AJUSTE' in mov.tipo %}background-color: rgba(0, 179, 255, 0.15) !important;{% endif %}">
                        <td>{{ mov.data_movimentacao.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('detalhes_lotes', item_id=mov.item.id) }}" title="Ver lotes de {{ mov.item.descricao }}">
                                {{ mov.item.codigo }} - {{ mov.item.descricao }}
                            </a>
                        </td>
                        <td>
                            <span class="badge 
                                {% if 'AJUSTE' in mov.tipo %} bg-warning text-dark
                                {% elif 'ENTRADA' in mov.tipo %} bg-success 
                                {% elif 'SAIDA' in mov.tipo %} bg-danger
                                {% else %} bg-secondary {% endif %}">
                                {{ mov.tipo }}
                            </span>
                        </td>
                        <td class="text-center fw-bold">{{ mov.quantidade }}</td>
                        <td>{{ mov.lote }} / {{ mov.item_nf }}</td>
                        <td>{{ mov.etapa or 'N/A' }}</td>
                        <td>{{ mov.usuario }}</td>
                        <td>{{ mov.observacao }}</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('detalhes_lotes', item_id=mov.item.id) }}" class="btn btn-info btn-sm" title="Ver Lotes deste Item">
                                    <i class="fas fa-boxes"></i>
                                </a>
                                {% if current_user.role == 'admin' %}
                                <a href="{{ url_for('apagar_movimentacao', mov_id=mov.id) }}" class="btn btn-warning btn-sm" title="Apagar Linha (mantém quantidade no estoque)" onclick="return confirm('Apagar este registro de movimentação? A quantidade no estoque será mantida.');">
                                    <i class="fas fa-times"></i>
                                </a>
                                <a href="{{ url_for('excluir_movimentacao', mov_id=mov.id) }}" class="btn btn-danger btn-sm" title="Reverter Movimentação (desfaz operação no estoque)" onclick="return confirm('Atenção! Esta ação irá reverter a operação no estoque (devolver ou retirar a quantidade) e apagar este registro de movimentação. Tem certeza?');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-4">Nenhuma movimentação encontrada para os filtros aplicados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Verifica se os dados do gráfico existem
    const pieData = {{ pie_chart_data|tojson }};
    if (pieData && pieData.counts.reduce((a, b) => a + b, 0) > 0) {
        const ctx = document.getElementById('movimentacoesPieChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: pieData.labels,
                datasets: [{
                    label: 'Nº de Transações',
                    data: pieData.counts,
                    backgroundColor: [
                        'rgba(0, 255, 0, 0.7)',   // Verde para Entradas
                        'rgba(255, 0, 255, 0.7)', // Magenta para Saídas
                        'rgba(255, 255, 0, 0.7)'  // Amarelo para Ajustes
                    ],
                    borderColor: [
                        '#00ff00',
                        '#ff00ff',
                        '#ffff00'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}