<!-- /templates/consumivel.html -->
{% extends 'base.html' %}

{% block title %}Consum√≠veis - SERCO ENGENHARIA Almoxarifado{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Estoque de Consum√≠veis {% if search_query %}<small class="text-muted fs-6"> - Exibindo resultados para "{{
            search_query }}"</small>{% endif %}</h3>
    <div class="btn-group">
        <a href="{{ url_for('movimentacao_consumivel') }}" class="btn btn-primary"><i class="fas fa-exchange-alt"></i>
            Movimenta√ß√£o</a>
        <a href="{{ url_for('exportar_consumivel') }}" class="btn btn-info"><i class="fas fa-download"></i> Exportar
            Excel</a>
        {% if current_user.role == 'admin' %}
        <a href="{{ url_for('importar_consumivel') }}" class="btn btn-success"><i class="fas fa-file-excel"></i>
            Importar Planilha</a>
        {% endif %}
    </div>
</div>

<!-- ABAS PARA NAVEGAR ENTRE ESTOQUE E RELAT√ìRIO -->
<ul class="nav nav-tabs mb-4" id="consumivelTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="estoque-tab" data-bs-toggle="tab" data-bs-target="#estoque-pane"
            type="button" role="tab" aria-controls="estoque-pane" aria-selected="true">
            <i class="fas fa-boxes me-2"></i>Estoque
        </button>
    </li>
    <li class="nav-item" role="presentation">
        {% if current_user.role == 'admin' %}
        <button class="nav-link" id="relatorio-tab" data-bs-toggle="tab" data-bs-target="#relatorio-pane" type="button"
            role="tab" aria-controls="relatorio-pane" aria-selected="false">
            <i class="fas fa-chart-bar me-2"></i>Relat√≥rio de Movimenta√ß√£o
        </button>
        {% else %}
        <button class="nav-link" id="relatorio-tab-disabled" type="button" disabled
            title="Acesso restrito a administradores">
            <i class="fas fa-chart-bar me-2"></i>Relat√≥rio de Movimenta√ß√£o
        </button>
        {% endif %}
    </li>
</ul>

<!-- CONTE√öDO DAS ABAS -->
<div class="tab-content" id="consumivelTabContent">

    <!-- ABA 1: ESTOQUE -->
    <div class="tab-pane fade show active" id="estoque-pane" role="tabpanel" aria-labelledby="estoque-tab">

        <!-- Formul√°rio de Busca -->
        <div class="card mb-4" id="formulario-busca">
            <div class="card-body">
                <form action="{{ url_for('consumivel') }}" method="get" class="row g-3 align-items-center">
                    <div class="col">
                        <input type="text" class="form-control" name="q"
                            placeholder="Buscar por C√≥digo, Descri√ß√£o, Categoria..." value="{{ search_query or '' }}">
                    </div>
                    <div class="col-auto btn-group gap-3">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
                        <a href="{{ url_for('consumivel') }}" class="btn btn-secondary"><i class="fas fa-eraser"></i>
                            Limpar</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-estoque">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" class="col-codigo">N¬∫ PRODUTO</th>
                                <th scope="col" class="col-codigo">C√ìDIGO</th>
                                <th scope="col" class="col-descricao">DESCRI√á√ÉO</th>
                                <th scope="col">CATEGORIA</th>
                                <th scope="col">UNIDADE</th>
                                <th scope="col" class="text-center col-qtd">QTD. ATUAL</th>
                                <th scope="col" class="text-center">ESTOQUE M√çN.</th>
                                <th scope="col" class="text-center col-acoes">A√á√ïES</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consumivel in consumiveis %}
                            {# Calculate color based on quantity vs minimum stock #}
                            {% if consumivel.quantidade_atual <= consumivel.estoque_minimo %} {% set
                                qty_color='var(--neon-red)' %} {% set qty_status='CR√çTICO' %} {% elif
                                consumivel.quantidade_atual <=(consumivel.estoque_minimo * 1.5) %} {% set
                                qty_color='var(--neon-yellow)' %} {% set qty_status='ATEN√á√ÉO' %} {% else %} {% set
                                qty_color='var(--neon-green)' %} {% set qty_status='OK' %} {% endif %} <tr>
                                <td class="ps-4" title="{{ consumivel.n_produto }}">
                                    <span class="text-mono" style="color: var(--text-secondary); font-size: 0.85rem;">
                                        {{ consumivel.n_produto | truncate(12) }}
                                    </span>
                                </td>
                                <td title="{{ consumivel.codigo_produto }}">
                                    <span class="badge-codigo">{{ consumivel.codigo_produto | truncate(15) }}</span>
                                </td>
                                <td title="{{ consumivel.descricao }}">
                                    <div class="text-truncate"
                                        style="max-width: 300px; color: var(--text-primary); font-weight: 500;">
                                        {{ consumivel.descricao }}
                                    </div>
                                    <small class="d-block text-muted" style="font-size: 0.75rem;">Status: {{
                                        consumivel.status_consumo or 'N/D' }}</small>
                                </td>
                                <td><span style="color: var(--text-secondary);">{{ consumivel.categoria or 'N/A'
                                        }}</span></td>
                                <td class="text-center"><span style="color: var(--text-secondary);">{{
                                        consumivel.unidade_medida or 'UN' }}</span></td>
                                <td class="text-center">
                                    <span
                                        style="font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 1.1rem; color: {{ qty_color }};">
                                        {{ "%.2f"|format(consumivel.quantidade_atual) }}
                                    </span>
                                </td>
                                <td class="text-center">{{ "%.2f"|format(consumivel.estoque_minimo) }}</td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('historico_consumivel', consumivel_id=consumivel.id) }}"
                                            class="btn btn-sm btn-info" title="Hist√≥rico"><i
                                                class="fas fa-history"></i></a>
                                        {% if current_user.role == 'admin' %}
                                        <a href="{{ url_for('editar_consumivel', consumivel_id=consumivel.id) }}"
                                            class="btn btn-sm btn-warning" title="Editar"><i
                                                class="fas fa-edit"></i></a>
                                        <a href="{{ url_for('excluir_consumivel', consumivel_id=consumivel.id) }}"
                                            class="btn btn-sm btn-danger" title="Excluir"
                                            onclick="return confirm('Tem certeza que deseja excluir este consum√≠vel? Esta a√ß√£o n√£o pode ser desfeita.');"><i
                                                class="fas fa-trash-alt"></i></a>
                                        {% endif %}
                                    </div>
                                </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">Nenhum consum√≠vel encontrado. Que tal <a
                                            href="{{ url_for('importar_consumivel') }}">importar uma planilha</a>?</td>
                                </tr>
                                {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- FIM ABA 1: ESTOQUE -->

    <!-- ABA 2: RELAT√ìRIO DE MOVIMENTA√á√ÉO -->
    <div class="tab-pane fade" id="relatorio-pane" role="tabpanel" aria-labelledby="relatorio-tab">
        {% if current_user.role == 'admin' %}
        <div class="card-header bg-dark-2 border-secondary">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Relat√≥rio de Movimenta√ß√µes de Consum√≠veis</h5>
        </div>
        <div class="card-body">
            <!-- Resumo em Texto das Movimenta√ß√µes - COLOCADO NO TOPO ANTES DOS FILTROS -->
            <div class="mb-4">
                <div class="alert alert-info border">
                    <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Resumo das Movimenta√ß√µes de
                        Consum√≠veis</h6>
                    {% if movimentacoes %}
                    {% set total_mov = movimentacoes|length %}
                    {% set entradas = movimentacoes|selectattr('tipo', 'equalto', 'ENTRADA')|list %}
                    {% set saidas = movimentacoes|selectattr('tipo', 'equalto', 'SAIDA')|list %}
                    {% set total_entradas = entradas|map(attribute='quantidade')|sum %}
                    {% set total_saidas = saidas|map(attribute='quantidade')|sum %}

                    <p><strong>üìä Per√≠odo Analisado:</strong> {{ total_mov }} movimenta√ß√£o(√µes) registrada(s)</p>

                    <p><strong>üìã Resumo Geral:</strong></p>
                    <ul class="mb-3">
                        <li><span class="badge bg-success">‚úì ENTRADAS</span> {{ entradas|length }} movimenta√ß√£o(√µes) |
                            Total: <strong>{{ "%.2f"|format(total_entradas) }}</strong> unidades</li>
                        <li><span class="badge bg-danger">‚úó SA√çDAS</span> {{ saidas|length }} movimenta√ß√£o(√µes) | Total:
                            <strong>{{ "%.2f"|format(total_saidas) }}</strong> unidades
                        </li>
                    </ul>

                    <p><strong>üì¶ Detalhamento por Produto:</strong></p>
                    <ul class="small">
                        {% set produtos = {} %}
                        {% for mov in movimentacoes %}
                        {% if mov.consumivel.codigo_produto not in produtos %}
                        {% set _ = produtos.update({mov.consumivel.codigo_produto: {'desc': mov.consumivel.descricao,
                        'unidade': mov.consumivel.unidade_medida or 'UN', 'entradas': 0, 'saidas': 0, 'total_entrada':
                        0, 'total_saida': 0}}) %}
                        {% endif %}
                        {% if mov.tipo == 'ENTRADA' %}
                        {% set _ = produtos[mov.consumivel.codigo_produto].update({'entradas':
                        produtos[mov.consumivel.codigo_produto].entradas + 1, 'total_entrada':
                        produtos[mov.consumivel.codigo_produto].total_entrada + mov.quantidade}) %}
                        {% else %}
                        {% set _ = produtos[mov.consumivel.codigo_produto].update({'saidas':
                        produtos[mov.consumivel.codigo_produto].saidas + 1, 'total_saida':
                        produtos[mov.consumivel.codigo_produto].total_saida + mov.quantidade}) %}
                        {% endif %}
                        {% endfor %}

                        {% for codigo, prod in produtos.items() %}
                        <li><strong>{{ codigo }}</strong> - {{ prod.desc }}:<br>
                            {% if prod.entradas > 0 %}
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="badge bg-success">ENTRADA</span> {{ prod.entradas }}
                            movimenta√ß√£o(√µes) = <strong>{{ "%.2f"|format(prod.total_entrada) }}</strong> {{ prod.unidade
                            }}<br>
                            {% endif %}
                            {% if prod.saidas > 0 %}
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="badge bg-danger">SA√çDA</span> {{ prod.saidas }}
                            movimenta√ß√£o(√µes) = <strong>{{ "%.2f"|format(prod.total_saida) }}</strong> {{ prod.unidade
                            }}<br>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center mb-0">Nenhuma movimenta√ß√£o registrada at√© o momento.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Filtros do Relat√≥rio -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="filtro-tipo" class="form-label">Tipo de Movimenta√ß√£o</label>
                    <select class="form-select" id="filtro-tipo">
                        <option value="">Todas</option>
                        <option value="ENTRADA">Entrada</option>
                        <option value="SAIDA">Sa√≠da</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtro-etapa" class="form-label">Etapa/Setor</label>
                    <input type="text" class="form-control" id="filtro-etapa" placeholder="Filtrar por etapa...">
                </div>
                <div class="col-md-3">
                    <label for="filtro-consumivel" class="form-label">Consum√≠vel</label>
                    <input type="text" class="form-control" id="filtro-consumivel"
                        placeholder="Filtrar por c√≥digo/descri√ß√£o...">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="aplicar-filtros"><i class="fas fa-filter me-2"></i>Aplicar
                        Filtros</button>
                </div>
            </div>

            <!-- Tabela de Movimenta√ß√µes -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>C√≥digo Produto</th>
                            <th>Descri√ß√£o</th>
                            <th>Quantidade</th>
                            <th>Unidade</th>
                            <th>Etapa/Setor</th>
                            <th>Usu√°rio</th>
                            <th>Observa√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if movimentacoes %}
                        {% for mov in movimentacoes %}
                        <tr>
                            <td>{{ mov.data_movimentacao.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td><span
                                    class="badge {% if mov.tipo == 'ENTRADA' %}bg-success{% else %}bg-danger{% endif %}">{{
                                    mov.tipo }}</span></td>
                            <td><strong>{{ mov.consumivel.codigo_produto }}</strong></td>
                            <td>{{ mov.consumivel.descricao }}</td>
                            <td class="text-end fw-bold">{{ "%.2f"|format(mov.quantidade) }}</td>
                            <td>{{ mov.consumivel.unidade_medida or 'UN' }}</td>
                            <td><small>{{ mov.setor_destino or 'N/A' }}</small></td>
                            <td>{{ mov.usuario or 'Sistema' }}</td>
                            <td>{{ mov.observacao or '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">Nenhuma movimenta√ß√£o encontrada.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Resumo Estat√≠stico -->
            <div class="row mt-4">
                {% set total_mov = movimentacoes|length %}
                {% set entradas = movimentacoes|selectattr('tipo', 'equalto', 'ENTRADA')|list %}
                {% set saidas = movimentacoes|selectattr('tipo', 'equalto', 'SAIDA')|list %}
                {% set total_entradas = entradas|map(attribute='quantidade')|sum %}
                {% set total_saidas = saidas|map(attribute='quantidade')|sum %}

                <div class="col-md-4">
                    <div class="card bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <p class="text-muted">Total de Movimenta√ß√µes</p>
                            <h4 class="text-info">{{ total_mov }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success bg-opacity-10 border-success">
                        <div class="card-body">
                            <p class="text-muted">Total Entradas</p>
                            <h4 class="text-success">{{ "%.2f"|format(total_entradas) }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger bg-opacity-10 border-danger">
                        <div class="card-body">
                            <p class="text-muted">Total Sa√≠das</p>
                            <h4 class="text-danger">{{ "%.2f"|format(total_saidas) }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading"><i class="fas fa-lock me-2"></i>Acesso Negado</h4>
        <p>Desculpe, voc√™ n√£o tem permiss√£o para acessar o Relat√≥rio de Movimenta√ß√µes de Consum√≠veis.</p>
        <p class="mb-0"><strong>Esta funcionalidade √© restrita apenas a administradores.</strong></p>
    </div>
    {% endif %}
</div>

</div>
<!-- FIM TAB-CONTENT -->

<script>
    $(document).ready(function () {
        // Quando a aba de relat√≥rio √© clicada, carregar dados via API
        $('#relatorio-tab').on('show.bs.tab', function () {
            fetch('{{ url_for("api_relatorio_movimentacoes_consumivel") }}')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 302 || response.status === 401) {
                            // Redirecionar se n√£o autorizado
                            window.location.href = '{{ url_for("index") }}';
                        }
                        throw new Error('Acesso negado');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        });

        // Recarregar p√°gina a cada 10 segundos para atualizar movimenta√ß√µes
        setTimeout(function () {
            location.reload();
        }, 10000);
    });
</script>

{% endblock %}</div>